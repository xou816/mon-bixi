import { Group, Path } from "react-konva";
import { colorRed60 } from "./story-content";
import { RefObject, useEffect, useRef, useState } from "react";
import Konva from "konva";
import { Node } from "konva/lib/Node";

function FrontWheel({ animated }: { animated: boolean }) {
    const [wheelFrame, setWheelFrame] = useState(0)
    const ref = useRef<Node>(null)

    const lastTime = useRef(0)
    const animation = useRef(new Konva.Animation((frame) => {
        const curTime = Math.floor(frame.time / 100)
        const draw = curTime !== lastTime.current
        lastTime.current = curTime
        if (draw) {
            setWheelFrame(v => (v + 1) % 5)
        }
        return draw
    }, ref.current?.getLayer()))

    useEffect(() => {
        if (animated) animation.current.start()
    }, [animated])
    return (
        <Group ref={ref as any}>
            <Path
                key="wheel-outer"
                fill="black"
                data="m 163.2407,133.8534 c -0.52521,0.0478 -0.0438,0.39382 1.50326,1.13791 16.04647,7.71804 18.48596,28.99223 4.84467,42.25117 -14.97696,14.55717 -38.23148,8.47186 -42.40051,-11.09545 -0.41014,-1.92498 -0.87661,-2.32267 -0.63769,-0.54363 1.41621,10.54546 9.49094,19.024 19.91713,20.91293 21.00907,3.80623 39.78695,-20.18014 31.45906,-40.18462 -2.54057,-6.10274 -8.94023,-11.8559 -13.82706,-12.43025 -0.39656,-0.0466 -0.68379,-0.064 -0.85886,-0.0481 z m -15.37167,6.6182 c -0.59957,-0.0179 0.26259,3.70588 2.46238,10.59212 3.57364,11.18693 3.72774,13.39435 0.87126,12.48089 -1.04365,-0.33375 -1.37103,-0.24465 -0.80822,0.22014 0.14938,0.12337 0.6137,0.31961 1.03198,0.43615 2.99725,0.83514 3.34496,-1.57267 1.34307,-9.29866 -1.88705,-7.28277 -4.00798,-13.75744 -4.69274,-14.32574 -0.0823,-0.0683 -0.15137,-0.10322 -0.20773,-0.1049 z" />
            <Path
                key="wheel-0"
                fill={wheelFrame === 0 ? "black" : undefined}
                data="m 172.19339,161.26206 -0.51263,0.62683 c -0.2819,0.34471 -0.77912,1.32263 -1.10484,2.173 -2.61606,6.82973 -9.48634,13.11458 -16.07603,14.70608 -0.59755,0.14432 -1.17941,0.34684 -1.29294,0.4501 -0.36989,0.33642 1.2806,0.20081 3.05046,-0.25063 6.03657,-1.53976 12.72656,-7.07783 15.30398,-12.669 0.6401,-1.38861 0.71459,-1.82111 0.66249,-3.84111 z" />
            <Path
                key="wheel-1"
                fill={wheelFrame === 1 ? "black" : undefined}
                data="m 149.30225,179.17107 c -7.67428,-1.73243 -16.54302,-11.58345 -17.45511,-19.3884 -0.25472,-2.17967 0.53988,-1.15947 3.58758,4.60613 5.47588,10.35924 12.76551,14.78389 21.98436,13.34405 2.50979,-0.39199 2.56159,-0.2824 0.37188,0.7868 l -1.79704,0.87745 -2.51354,0.0749 c -1.49399,0.0445 -3.18874,-0.0775 -4.17813,-0.3009 z" />
            <Path
                key="wheel-2"
                fill={wheelFrame === 2 ? "black" : undefined}
                data="m 136.11782,167.56977 c -3.90304,-5.15228 -5.49269,-9.31125 -5.69999,-14.91282 l -0.1328,-3.58845 c 0.9168,-0.97693 1.63023,-2.42845 2.92307,-2.96182 0.6889,-0.10022 0.67472,-0.22946 0.20335,1.85406 -1.4306,6.3234 -0.21993,12.67656 3.47435,18.23224 1.8565,2.79192 1.19813,3.9722 -0.76798,1.37679 z" />
            <Path
                key="wheel-3"
                fill={wheelFrame === 3 ? "black" : undefined}
                data="m 167.13399,145.26331 c -0.4198,-0.31748 -1.53719,-1.30705 -2.48307,-2.19904 -4.33249,-4.08562 -9.12926,-6.1637 -14.63058,-6.33834 -2.97903,-0.0946 -3.147,-0.17317 -2.29898,-1.07584 2.84779,-3.03134 14.32326,0.68313 18.52243,5.99548 2.39404,3.02869 2.91596,5.14976 0.8902,3.61774 z" />
            <Path
                key="wheel-4"
                fill={wheelFrame === 4 ? "black" : undefined}
                data="m 171.44323,164.10302 -0.53423,-1.39033 c 1.27601,-10.62428 -4.34854,-18.05716 -4.40619,-18.47169 0,-1.34196 2.79082,2.05608 4.36418,5.31371 1.58901,3.29004 1.76806,4.40963 1.67145,10.45104 -0.17229,0.14855 -1.09521,4.09727 -1.09521,4.09727 z" />
        </Group>
    )
}

export function BixiBike({ x, y, scale, animated }: { x: number; y: number; scale: number; animated: boolean }) {
    const groupRef = useRef<Node>(null)
    const fullBike = useRef<Node>(null)
    const bikeFrame = useRef<Node>(null)

    useEffect(() => {
        if (!fullBike.current) return
        fullBike.current.cache({ pixelRatio: 5 })
    }, [])

    const animation = useRef(new Konva.Animation((frame) => {
        if (!groupRef.current || !bikeFrame.current) return
        const cos = 5 * Math.cos(frame.time * 1e-3)
        groupRef.current.setAttr("offsetX", cos)
    }, groupRef.current?.getLayer()))

    useEffect(() => {
        if (!animated) animation.current.stop()
        else animation.current.start()
        return () => { animation.current.stop() }
    }, [animated])

    return (
        <Group ref={groupRef as any} offsetY={50} x={x} y={y} scaleX={scale} scaleY={scale}>
            <FrontWheel animated={animated} />
            <Group ref={fullBike as any}>
                <Path
                    ref={bikeFrame as any}
                    fill={colorRed60}
                    data="m 129.01003,95.187985 c -2.57174,0.837315 -15.32641,-0.14341 -7.83431,6.504285 1.40664,1.24811 5.52374,-2.23738 7.83104,5.20134 0.30499,0.98328 0.55152,2.04116 1.05317,3.69848 0,0.0914 1.57815,7.22093 0.76067,8.34885 -6.52601,8.68023 -12.60412,18.22448 -15.39337,22.06687 -3.75632,5.17461 -6.3071,9.44722 -13.26482,10.05313 l -2.834457,0.0987 -2.354895,-5.94537 c -3.146179,-7.6897 -5.90753,-15.50525 -8.533846,-23.38204 -0.629061,-1.82365 -0.608752,-3.63749 -4.336686,-3.12384 -4.480057,0.61729 -2.536547,1.80143 -1.588534,4.26434 0.508528,1.13368 0.91292,2.30875 1.333252,3.47679 -2.209641,1.72131 -5.343763,7.0661 -7.944735,4.95474 -6.086325,-5.08905 -18.937865,-4.54188 -27.834993,1.18546 -6.446559,4.14983 -14.55579,14.79607 -15.257984,20.03133 -0.165501,1.2339 0.705825,1.0982 0.904338,1.125 0.428441,0.0579 17.214958,0.58806 24.904423,0.62509 l -1.088822,1.42059 c -2.698801,3.52114 -2.035112,6.43919 1.571997,6.9112 0.57123,0.0748 6.867398,0.14073 13.991394,0.14573 l 15.636255,0.21412 c 1.601151,0 1.600836,1.1e-4 1.604036,0.81494 0.01333,3.38254 2.177762,6.78156 4.92218,7.73028 v -5.2e-4 c 4.350879,1.50407 9.488297,-2.02858 10.531137,-7.24142 0.32481,-1.62366 0.42259,-1.72936 1.60094,-1.73736 0.9841,-0.007 6.40255,-0.45385 9.07541,-3.08767 5.21542,-6.27025 9.41547,-13.62877 13.93455,-20.48867 6.58768,-10.07759 5.68288,-9.3166 6.95255,-5.84925 1.17302,3.20341 1.16397,3.12292 0.43563,3.80131 -4.66254,4.34283 -10.11059,15.09433 -12.79715,25.25479 -0.84085,3.18004 -0.74432,3.47533 0.79117,2.41123 2.1956,-1.52154 16.55072,-17.69164 16.61449,-17.62787 0.0294,0.0294 0.95086,2.30183 2.04742,5.04931 2.99052,7.49283 5.22396,11.05967 5.79323,11.38094 6.03561,3.40614 1.13411,-9.07772 0.0586,-12.50542 -2.29615,-7.18774 -2.87352,-9.26946 -2.36472,-10.60091 0.0904,-0.23662 5.47767,-6.13452 6.74998,-8.03982 0.86472,-1.29492 0.86493,-1.29504 0.36277,-1.49448 -0.9606,-0.38152 -5.58221,-0.2267 -7.34684,0.24598 -0.89631,0.24008 -1.77391,0.46998 -1.94975,0.51108 -0.24629,0.0576 -0.72002,-1.32869 -2.06396,-6.03787 l -5.27151,-18.42162 c -2.08154,-6.37654 -2.36266,-14.232772 -7.60617,-12.525572 z M 85.704045,131.43273 c 0.0054,-3.1e-4 0.01069,-2e-4 0.01602,0 0.284311,0.011 0.519681,0.76385 1.230416,2.86856 0.886982,2.62663 2.116948,6.02128 4.669482,12.8881 0.597426,1.60719 1.064786,2.93943 1.038696,2.96003 -0.580609,0.45896 -6.894365,0.17223 -6.908105,-0.31368 -0.0089,-0.31399 -0.05706,-0.81537 -0.10697,-1.11414 -0.04991,-0.29877 -0.201245,-1.2274 -0.336414,-2.06396 -0.492234,-3.04644 -3.059896,-9.30355 -3.47524,-9.88673 -0.324299,-0.45534 -0.03933,-1.0541 1.16427,-2.3611 0.74693,-0.8111 1.292253,-1.39991 1.670572,-1.86881 0.309317,-0.38336 0.870848,-1.09862 1.037273,-1.10827 z" />
                <Path
                    fill="white"
                    data="m 126.76123,129.07705 c 0.5711,0 1.55572,2.07138 2.23604,4.70307 1.08671,4.20373 -1.20674,2.0206 -2.47065,-2.3518 -0.52353,-1.81112 -0.46952,-2.35127 0.23461,-2.35127 z m -2.096,2.7404 c 0.30628,-0.007 0.71626,0.96758 0.91209,2.69854 0.13403,1.18463 0.22696,1.36854 0.99994,1.98076 1.09388,0.86638 1.10059,1.62744 0.014,1.54254 -0.70606,-0.0551 -0.7059,-0.055 -0.7059,1.00562 0,2.29273 -1.14525,1.70658 -1.37407,-0.70331 -0.0955,-1.00614 -0.22623,-1.34718 -0.6227,-1.62058 -0.89232,-0.61531 -1.73533,-1.55471 -1.64383,-1.83244 0.1368,-0.41539 0.94703,-0.44543 1.53944,-0.0574 0.53195,0.34855 0.53198,0.34848 0.50178,-1.22939 -0.0233,-1.21617 0.14855,-1.77901 0.3793,-1.78438 z m -3.31711,5.51025 c 0.79348,0.01 2.58124,3.27344 2.58124,5.11545 0,0.93079 -0.88154,1.10808 -1.33532,0.26872 -0.42626,-0.78846 -1.64166,-4.81139 -1.54306,-5.10718 0.0644,-0.19319 0.1673,-0.27855 0.29714,-0.27699 z m -0.20567,5.50044 c 0.85309,-0.0336 1.48363,1.01228 1.48363,2.92541 0,1.44925 -0.50502,2.57891 -1.39526,3.12177 -0.9788,0.59688 -1.51534,0.51471 -2.16059,-0.33125 -0.40946,-0.53681 -0.68543,-0.70985 -1.00098,-0.62735 -0.6858,0.17934 -0.84288,-0.56456 -0.22479,-1.06505 0.50619,-0.40989 0.50653,-0.4099 -0.19275,-1.40198 -0.77068,-1.09337 -0.82092,-1.88633 -0.12558,-1.98593 0.31285,-0.0448 0.57075,0.16326 0.88677,0.71624 l 0.44545,0.7798 0.59583,-0.85938 c 0.58437,-0.84324 1.17642,-1.25215 1.68827,-1.27228 z m -0.008,1.51671 c -0.14602,0.007 -0.36309,0.25435 -0.73587,0.74569 -0.65621,0.86491 -0.73766,1.36864 -0.32763,2.0252 0.55666,0.89136 1.62536,-0.72692 1.37201,-2.07739 -0.0878,-0.46823 -0.16249,-0.70083 -0.30851,-0.6935 z" />
                <Path
                    fill="black"
                    data="m 153.77586,90.705502 c -0.60873,0 -0.8168,0.563992 -0.6289,1.702739 0.092,0.557525 0.56592,3.357879 1.05316,6.222875 2.27207,13.359794 2.60678,13.043134 -13.7852,13.043134 -5.97544,0 -10.98688,0.079 -11.13627,0.1757 -0.68634,0.44421 0.40548,5.80157 1.41438,6.94014 0.99857,1.12691 1.2555,-0.0524 0.60203,-2.76469 -0.30225,-1.25454 -0.54984,-2.42924 -0.54984,-2.61017 0,-0.3758 -0.99068,-0.34116 11.73365,-0.40876 9.49768,-0.0504 9.77038,-0.0849 11.86595,-1.49759 2.68705,-1.81143 2.84417,-6.42324 0.60409,-17.738965 -0.60256,-3.043858 -0.61041,-3.064413 -1.17305,-3.064413 z m -31.28521,3.946367 c -2.74414,-1.6e-5 -4.72412,2.35651 -4.7241,5.100648 -2e-5,2.744143 2.40883,3.976683 5.15296,3.976663 2.74414,2e-5 4.28257,-1.69438 4.28255,-4.43851 2e-5,-2.744143 -1.96728,-4.638817 -4.71141,-4.638801 z M 74.42153,112.8411 c -1.936924,-0.0707 -3.121891,0.37974 -4.008541,1.38958 -2.101017,2.39293 -1.158046,5.92373 1.847432,6.91741 1.073441,0.3549 8.114276,-0.005 13.249837,-0.67645 8.768659,-1.14713 10.903728,-1.88595 10.903728,-3.77289 0,-2.32725 -2.133878,-2.99232 -7.822779,-2.43913 -4.274757,0.41567 -4.914525,0.36731 -9.773047,-0.73691 -1.801466,-0.40942 -3.234476,-0.63918 -4.39663,-0.68161 z m 64.82757,5.22656 c -1.9917,-0.0237 -4.03168,0.0499 -4.3894,0.24133 -0.98684,0.52814 -0.47933,0.84255 1.48105,0.91725 6.73607,0.25659 7.79512,0.13276 7.00732,-0.81649 -0.16404,-0.19765 -2.10728,-0.3184 -4.09897,-0.34209 z m -64.608462,26.15757 c -0.487636,-0.0257 -6.340029,4.75315 -9.353435,7.67964 -2.417693,2.34795 -2.947859,3.14021 -2.281514,3.40909 0.471994,0.19049 2.594339,0.14874 4.508769,-0.0884 1.015825,-0.12581 3.489154,-0.29727 5.496305,-0.38137 2.871098,-0.12026 3.693036,-0.22188 3.853512,-0.47594 0.672208,-1.06423 -0.813076,-1.09257 -9.404078,-0.18035 -3.146315,0.33408 -3.446816,0.17641 -1.968355,-1.03198 1.320416,-1.07921 9.055047,-8.5498 9.172567,-8.8594 0.01761,-0.0464 0.0087,-0.0696 -0.02377,-0.0713 z m -38.543901,3.60857 c -0.167393,-0.004 -0.574041,0.56569 -1.19941,1.80454 -8.077569,16.00157 2.142252,34.66684 20.122803,36.75124 10.544505,1.22238 23.075457,-5.71557 29.038021,-16.07757 1.523873,-2.64825 2.762878,-5.7614 3.337264,-8.38347 0.739562,-3.3761 -0.258654,-2.2789 -1.533757,1.68569 -5.13811,15.97558 -22.920353,25.46377 -37.493835,20.0055 -12.732089,-4.7686 -18.436583,-18.83977 -13.134599,-32.39958 0.841451,-2.152 1.108165,-3.38104 0.863513,-3.38635 z m 59.172099,10.71407 c -0.23588,0.002 -0.566895,0.30587 -1.176672,0.96067 -2.628152,2.82219 -2.182396,7.35397 0.908988,9.23923 1.826674,1.11398 4.960866,-0.22 6.030118,-2.56677 0.46166,-1.01323 -0.17993,-1.10799 -0.69298,-0.10232 -1.274331,2.4979 -4.511976,2.73152 -6.031669,0.43511 -1.199241,-1.81218 -0.884901,-4.09269 0.818554,-5.94072 0.793184,-0.86051 0.844168,-0.98741 0.607715,-1.50637 -0.1548,-0.33975 -0.280592,-0.52059 -0.464054,-0.51883 z m -22.455994,13.11445 c -0.282027,0.0118 -1.220966,0.49739 -2.85719,1.45366 -7.136754,4.17098 -14.005231,5.36788 -19.572448,3.41116 -0.659514,-0.23181 -1.244313,-0.37621 -1.299663,-0.32091 -0.407847,0.40785 1.763121,1.41838 4.198194,1.95388 6.208547,1.36533 13.669775,-0.64705 18.246431,-4.92114 1.140476,-1.06508 1.584899,-1.5892 1.284676,-1.57665 z" />
            </Group>
        </Group>
    );
}
